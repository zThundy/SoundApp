name: Build and Release for Windows

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build-and-release-windows:
    runs-on: windows-latest

    if: contains(github.event.head_commit.message, '[build]')

    env:
      CI: false
      GITHUB_TOKEN: ${{ secrets.BUILD_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BUILD_SECRET }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Read version from package.json
        id: pkg
        run: |
          $pkg_version = (Get-Content -Path .\package.json | ConvertFrom-Json).version
          echo "Version: $pkg_version"
          echo "version=$pkg_version" >> $ENV:GITHUB_OUTPUT

      # - name: Extract version from package.json
      #   id: extract_react_version
      #   shell: pwsh
      #   run: |
      #     $pkg_version = (Get-Content -Path .\package.json | ConvertFrom-Json).version
      #     echo "Version: $pkg_version"
      #     echo "release_version=$pkg_version" >> $ENV:GITHUB_OUTPUT

      # - name: Create Git tag
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git tag v${{ env.VERSION }}
      #     git push origin v${{ env.VERSION }}
      #   shell: bash
      #   env:
      #     VERSION: ${{ env.VERSION }}
      #     GITHUB_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
      
      - name: Extract changelogs
        id: notes
        run: |
          $version = "${{ steps.pkg.outputs.version }}"
          $changelogFile = "releases.md"
          $changelogContent = Get-Content -Path $changelogFile -Raw -Encoding UTF8
          $versionHeader = "## $version"
          $nextVersionHeader = "## "
          $changelog = $changelogContent -split $versionHeader, 2 | Select-Object -Last 1
          $changelog = $changelog -split $nextVersionHeader, 2 | Select-Object -First 1
          echo "Changelog extracted"
          echo $changelog
          # write to temporary file
          $outputFile = "releases.tmp.md"
          $changelog | Out-File -FilePath $outputFile -Encoding UTF8
          # output to github action
          echo "outputFile=$outputFile" >> $ENV:GITHUB_OUTPUT

      - name: Build and publish
        run: |
          npm run publish

      - name: Update release notes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BUILD_SECRET }}
          script: |
            const fs = require('fs');
            const version = '${{ steps.pkg.outputs.version }}';
            const changelogFile = '${{ steps.notes.outputs.outputFile }}';
            const changelog = fs.readFileSync(changelogFile, 'utf-8');
            
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: `v${version}`
            });
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: changelog
            });

      - name: Bump package.json version (patch +0.0.1 for next dev)
        run: |
          git fetch origin master
          git pull origin master --rebase
          npm version patch --no-git-tag-version
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "[automated] chore: bump version for next development"; if ($LASTEXITCODE -ne 0) { echo "No changes to commit" }
          git push

      - name: Add next version to releases.md
        run: |
          git fetch origin master
          git pull origin master --rebase
          npm version patch --no-git-tag-version
          $nextVersion = (Get-Content -Path .\package.json | ConvertFrom-Json).version
          $releasesFile = "releases.md"
          $content = Get-Content -Path $releasesFile -Raw -Encoding UTF8
          $newSection = "`n`n## $nextVersion`n"
          $updatedContent = $content + $newSection
          $updatedContent | Out-File -FilePath $releasesFile -Encoding UTF8 -NoNewline
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add releases.md
          git commit -m "[automated] chore: add next version to releases.md"; if ($LASTEXITCODE -ne 0) { echo "No changes to commit" }
          git push

  update-readme:
    runs-on: windows-latest
    needs: build-and-release-windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Read version from package.json
        id: pkg
        run: |
          $pkg_version = (Get-Content -Path .\package.json | ConvertFrom-Json).version
          echo "Version: $pkg_version"
          echo "version=$pkg_version" >> $ENV:GITHUB_OUTPUT

      - name: Update README
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BUILD_SECRET }}
          script: |
            console.log("Got version: v${{ steps.pkg.outputs.version }}");
            const fs = require('fs');
            const readme = fs.readFileSync('README.md', 'utf-8');
            const newReadme = readme.replace(/v\d+\.\d+\.\d+/g, `v${{ steps.pkg.outputs.version }}`);
            fs.writeFileSync('README.md', newReadme);
            console.log('README updated with new version.');

      - name: Commit changes
        run: |
          git fetch origin ${{ github.head_ref }}
          git pull origin ${{ github.head_ref }}
          git config --global user.name 'Automatic update'
          git config --global user.email 'actions@github.com'
          git remote set-url origin https://x-access-token:${{ secrets.BUILD_SECRET }}@github.com/${{ github.repository }}
          git commit -am "[automated] chore: updated version of readme"
          git push
