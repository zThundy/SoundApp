name: Update Dependencies and Fix Security Alerts

on:
  schedule:
    # Runs every 2 hours
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Update dependencies and fix security vulnerabilities
        run: |
          # Update all dependencies to latest versions
          npm update --save
          
          # Run npm audit fix to automatically fix security vulnerabilities
          npm audit fix || true
          
          # Clean up
          npm dedupe
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet package.json package-lock.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json package-lock.json
          git commit -m "[automated] chore: update dependencies and fix security vulnerabilities"
          git push
      
      - name: Create issue if vulnerabilities remain
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            try {
              const auditOutput = execSync('npm audit --json', { encoding: 'utf-8' });
              const audit = JSON.parse(auditOutput);
              
              if (audit.metadata && audit.metadata.vulnerabilities.total > 0) {
                const vulnerabilities = audit.metadata.vulnerabilities;
                const body = `## ğŸ”’ Security Vulnerabilities Detected\n\n` +
                  `- **Critical:** ${vulnerabilities.critical}\n` +
                  `- **High:** ${vulnerabilities.high}\n` +
                  `- **Moderate:** ${vulnerabilities.moderate}\n` +
                  `- **Low:** ${vulnerabilities.low}\n\n` +
                  `Dependencies have been updated, but some vulnerabilities may require manual intervention.\n\n` +
                  `Run \`npm audit\` locally for more details.`;
                
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ğŸ”’ Security vulnerabilities need attention',
                  body: body,
                  labels: ['security', 'dependencies']
                });
              }
            } catch (error) {
              console.log('Error checking for vulnerabilities:', error.message);
            }
